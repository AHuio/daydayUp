### **==JAVA 执行系统的主流实现以及设计决策==**

#### Q1：为什麽JAVA要在虚拟机里运行？        
​    JAVA作为一门高级程序语言，它的语法非常复杂，抽象程度也很高。因此，直接在硬件上运行这种复杂的程序并不现实。所以，在运行JAVA程序之前，需要对其进行一番转换。

​	这个转换操作的主流思路是，设计一个面向JAVA语言特性的**虚拟机**，并通过编译器将JAVA程序转换成该虚拟机所能识别的指令序列，也就是**JAVA字节码**。

​	JAVA虚拟机可以由**硬件实现**，但更为常见的是在各个现有平台（如Windows_64、Linux_aarch64）上提供软件实现。这麽做的意义在于，一旦一个程序被转换为JAVA字节码，那摩它便可以在不同平台上的虚拟机实现里运行，也即是“一次编写，到处执行”。

​	虚拟机的另一个好处是它带来了一个托管环境（Managed Runtime）。这个托管环境能够代替我们处理一些代码中冗长而且容易出错的部分。其中最广为人知的当属**自动内存管理**和**垃圾回收**，这部分内容催生了一波垃圾回收调优的业务。

​	除此之外，托管环境还提供了诸如数组越界、动态类型、安全权限等等的动态检测，使得我们免于书写这些无关业务逻辑的代码。

#### Q2：JAVA虚拟机具体是怎样运行JAVA字节码的？
​	下面以标准JDK中的HotSpot虚拟机为例，从虚拟机以及底层硬件两个角度，讲述JAVA虚拟机具体是如何运行JAVA字节码的。

​	从**虚拟机视角**来看，执行JAVA代码首先需要将它编译而成的class文件加载到JAVA虚拟机中。加载后的JAVA类会被存放于**方法区（Method Area）中**。实际运行时虚拟机会执行方法区内的代码。

​	**JAVA虚拟机在内存中划分出堆和栈来存储运行时数据。**

​	**JAVA虚拟机会将栈细分为面向JAVA方法的JAVA方法栈，面向本地方法（用C++写的native方法）的本地方法栈，以及存放各个线程执行位置的PC寄存器**。

![01-figure1](/01-figure1.png) 

​	在运行过程中，每当调用进入一个JAVA方法，JAVA虚拟机会在**当前线程的JAVA方法栈**中生成一个**栈桢**，用以存放局部变量以及字节码的操作数。这个栈帧的大小是提前计算好的，而且JAVA虚拟机不要求栈帧在内存空间里连续分布。

​	当退出当前执行的方法时，不管是正常返回还是异常退出，JAVA虚拟机均会弹出当前线程的当前栈帧，并将其舍弃。

​	**从硬件视角来看，JAVA字节码无法直接执行。因此，JAVA虚拟机需要将字节码翻译成机器码。**

​	在**HotSpot**里面，上述翻译过程有两种形式：第一种是**解释执行**，即逐条将字节码翻译成机器码并执行；第二种是**即时编译（Just-In-Time compilation,  JIT）**，即将一个方法中包含的所有字节码编译成机器码之后再执行。

![01-figure2](/01-figure2.png)

​	前者的优势在于无需等待编译，而后者的优势在于实际运行速度更快。HotSpot